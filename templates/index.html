{% extends "layout.html" %}

{% block title %}My Fridge{% endblock %}

{% block main %}
<section id="item-catalog" class="container d-flex flex-wrap gap-4 justify-content-center">
    {% for item in items %}
    {% set card_class = '' %}
    {% set status_pill_class = 'status-ok' %}
    {% set status_icon = '' %}

    {% if item.days_left <= 0 %} {% set card_class='expired' %} {% set status_pill_class='status-expired' %} {% set
        status_icon='fa-circle-xmark' %} {% elif item.days_left <=3 %} {% set card_class='expiring-soon' %} {% set
        status_pill_class='status-expiring' %} {% set status_icon='fa-triangle-exclamation' %} {% endif %} <div
        class="card {{ card_class }}" style="width: 18rem;">
        <i class="fa-solid {{ status_icon }} card-status-icon"></i>
        <div class="card-body">
            <div>
                <div class="card-header-flex">
                    <h5 class="card-title">{{ item.name }}</h5>
                    <span class="status-pill {{ status_pill_class }}">
                        {% if item.days_left > 1 %}
                        in {{ item.days_left }} days
                        {% elif item.days_left == 1 %}
                        Tomorrow
                        {% elif item.days_left == 0 %}
                        Today
                        {% else %}
                        Expired
                        {% endif %}
                    </span>
                </div>
                <p class="card-text">{{ item.notes }}</p>
            </div>
            <div class="item-buttons">
                <a href="#" class="card-link" data-bs-toggle="modal" data-bs-target="#editItemModal"
                    data-item-id="{{ item.id }}" data-item-name="{{ item.name }}"
                    data-item-date="{{ item.expiration_date }}" data-item-notes="{{ item.notes }}"><i
                        class="fa-solid fa-pen-to-square"></i></a>
                <a href="{{ url_for('delete', item_id=item.id) }}" class="card-link text-danger"><i
                        class="fa-solid fa-trash"></i></a>
            </div>
        </div>
        </div>
        {% endfor %}
</section>

<section id="add-item">
    <button type="button" class="btn add-btn rounded-pill" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <i class="fa-solid fa-plus fa-2x"></i>
    </button>
</section>

<!-- Modals for adding and editing items -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="addItemModalLabel">Add a New Item</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action='/add'>
                    <div class="mb-3 form-group-icon">
                        <i class="fa-solid fa-tag form-icon"></i>
                        <input type="text" class="form-control" id="item-name" name="item-name"
                            placeholder="e.g., Milk, Eggs, Cheese" required>
                    </div>
                    <div class="mb-3 form-group-icon">
                        <i class="fa-solid fa-calendar-day form-icon"></i>
                        <input type="date" class="form-control" id="expiration-date" name="expiration-date" required>
                    </div>
                    <div class="mb-4 form-group-icon">
                        <i class="fa-solid fa-note-sticky form-icon" style="top: 25%;"></i>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                            placeholder="e.g., Opened on Monday, use for pancakes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add to Fridge</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="editItemModalLabel">Edit Item</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="editItemForm">
                    <input type="hidden" name="item_id" id="edit-item-id">
                    <div class="mb-3 form-group-icon">
                        <i class="fa-solid fa-tag form-icon"></i>
                        <input type="text" class="form-control" id="edit-item-name" name="item_name"
                            placeholder="e.g., Milk, Eggs, Cheese" required>
                    </div>
                    <div class="mb-3 form-group-icon">
                        <i class="fa-solid fa-calendar-day form-icon"></i>
                        <input type="date" class="form-control" id="edit-expiration-date" name="expiration_date"
                            required>
                    </div>
                    <div class="mb-4 form-group-icon">
                        <i class="fa-solid fa-note-sticky form-icon" style="top: 25%;"></i>
                        <textarea class="form-control" id="edit-notes" name="notes" rows="3"
                            placeholder="e.g., Opened on Monday, use for pancakes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var editModal = document.getElementById('editItemModal')
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var itemId = button.getAttribute('data-item-id');
            var itemName = button.getAttribute('data-item-name');
            var itemDate = button.getAttribute('data-item-date');
            var itemNotes = button.getAttribute('data-item-notes');
            var form = editModal.querySelector('#editItemForm');
            form.action = '/edit/' + itemId;
            var modalIdInput = editModal.querySelector('#edit-item-id');
            var modalNameInput = editModal.querySelector('#edit-item-name');
            var modalDateInput = editModal.querySelector('#edit-expiration-date');
            var modalNotesInput = editModal.querySelector('#edit-notes');
            modalIdInput.value = itemId;
            modalNameInput.value = itemName;
            modalDateInput.value = itemDate;
            modalNotesInput.value = itemNotes;
        })
        requestNotificationPermission();
        const itemsString = '{{ items | tojson }}';
        const items = JSON.parse(itemsString);
        const lastNotificationDate = localStorage.getItem('last_notification_date');
        const today = new Date().toDateString();
        if (lastNotificationDate !== today) {
            items.forEach(item => {
                if (item.days_left <= 2) {
                    showExpirationNotification(item.name, item.days_left);
                }
            })
            localStorage.setItem('last_notification_date', today)
        }
    })
    function requestNotificationPermission() {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                } else {
                    console.log('Notification permission denied.');
                }
            });
        } else {
            console.log('This browser does not support notifications.');
        }
    }
    function showExpirationNotification(itemName, daysLeft) {
        if (Notification.permission === 'granted') {
            let notificationBody = '';
            if (daysLeft === 0) {
                notificationBody = `${itemName} expires today!`;
            } else if (daysLeft > 0) {
                notificationBody = `${itemName} expires in ${daysLeft} day(s).`;
            } else {
                notificationBody = `${itemName} has expired.`;
            }
            new Notification('FreshFridge Alert', {
                body: notificationBody,
                icon: 'static/images/logo.png'
            })
        }
    }
</script>
{% endblock %}